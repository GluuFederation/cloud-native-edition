{% extends 'base.html' %}
{% block content %}
  <div class="container">
    <div class="card">
      <div class="card-header">
      </div>
      <div class="card-body">
        <form method="post" class="needs-validation">
          {{ form.csrf_token }}
          {% include '%s.html' % step %}
          {% if(next_step) %}
            {{ forms.hidden('next_step', next_step) }}
          {% endif %}
          <button type="submit" class="btn btn-primary float-right">Next</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block custom_script %}
  <script>

    showHideOption = function(target, value){
      if(value == 'Y'){
        target.collapse('show');
       }else{
        target.collapse('hide');
       }
    }

    $(document).ready(function () {
      {% if step == 'optional_services' %}
        $('input[name="enable_oxauth_key_rotate"]').on('change', function(){
        showHideOption($('#oxauthKeyLife'), $(this).val());
        });

        $('input[name="enable_oxd"]').on('change', function(){
          showHideOption($('#oxdSetup'), $(this).val());

        });

        $('input[name="enable_oxtrust_api"]').on('change', function(){
          showHideOption($('#oxtrustTestMode'), $(this).val());

        });
      {% endif %}

      {% if step == "gluu_gateway" %}
        $('input[name="install_gluu_gateway').on('change', function(){
          showHideOption($('#oxd-alert'), $(this).val());
          showHideOption($('#postgresSetup'), $(this).val());
          showHideOption($('#gluuGatewaySetup'), $(this).val());
        });
      {% endif %}

      {% if step == "install_jackrabbit" %}
        $('input[name="install_jackrabbit"').on('change', function(){
          if($(this).val() == 'Y'){
            $('#jackrabbitYesInstall').collapse('show');
             $('#jackrabbitNoInstall').collapse('hide');
           }else{
            $('#jackrabbitNoInstall').collapse('show');
            $('#jackrabbitYesInstall').collapse('hide');
           }
        });
      {% endif %}

      {% if step == "settings" %}
        IpAddress = function(){
          return Promise.resolve($.get('/determine_ip'));
        }

        ValidateIP = function(ip_address){
          return Promise.resolve($.get('/validate_ip/' + ip_address));
        }

        IpAddress().then(function(data){
          $('#host_ext_ip').val(data.ip_address);

          if(data.status){
            $('#host_ext_ip').addClass('is-valid');
            $('#host_ext_ip').closest('.form-group').find('.feedback').addClass('valid-feedback').html(data.message);
          }else{
            $('#host_ext_ip').addClass('is-invalid');
            $('#host_ext_ip').closest('.form-group').find('.feedback').addClass('invalid-feedback').html(data.message);
          }

          $('#validate-ip').collapse('show');

        });

        $('#validate-ip').on('click', function(){
          ValidateIP($('#host_ext_ip').val()).then(function(data){

           if(data.status){
              $('#host_ext_ip').removeClass('is-invalid');
              $('#host_ext_ip').addClass('is-valid');
              $('#host_ext_ip').closest('.form-group').find('.feedback').removeClass('invalid-feedback');
              $('#host_ext_ip').closest('.form-group').find('.feedback').addClass('valid-feedback').html(data.message);
              $("#validate-ip").collapse("hide");
            }else{
              $('#host_ext_ip').removeClass('is-valid');
              $('#host_ext_ip').closest('.form-group').find('.feedback').removeClass('valid-feedback');
              $('#host_ext_ip').addClass('is-invalid');
              $('#host_ext_ip').closest('.form-group').find('.feedback').addClass('invalid-feedback').html(data.message);
            }
            console.log(data);
          });
        });

        $('input[name="persistence_backend"]').on('change', function(){
          if($(this).val() == 'hybrid'){
            $('#hybridLdapHeldData').collapse('show');
          }else{
            $('#hybridLdapHeldData').collapse('hide');
          }
        });

        $('input[name="use_arn"]').on('change', function(){
          if($(this).val() == 'Y'){
            $('#arn_aws_iam').prop('disabled', false);
          }else{
            $('#arn_aws_iam').prop('disabled', true);
          }
        });

      {% endif %}
    });
  </script>
{% endblock %}